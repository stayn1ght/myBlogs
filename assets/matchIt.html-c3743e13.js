import{_ as c,r as l,o as i,c as r,f as t,a,e,d as p,b as o}from"./app-fda9dad6.js";const d={},m={href:"https://postimg.cc/k2FmYGh2",target:"_blank",rel:"noopener noreferrer"},u={href:"https://kosukeimai.github.io/MatchIt/index.html",target:"_blank",rel:"noopener noreferrer"},v={href:"https://zhuanlan.zhihu.com/p/559469895",target:"_blank",rel:"noopener noreferrer"};function k(g,n){const s=l("ExternalLinkIcon");return i(),r("div",null,[n[4]||(n[4]=t(`<h1 id="参数因果推理的非参数预处理" tabindex="-1"><a class="header-anchor" href="#参数因果推理的非参数预处理" aria-hidden="true">#</a> 参数因果推理的非参数预处理</h1><h2 id="conda-安装-matchit" tabindex="-1"><a class="header-anchor" href="#conda-安装-matchit" aria-hidden="true">#</a> conda 安装 MatchIt</h2><div class="language-bash line-numbers-mode" data-ext="sh"><pre class="language-bash"><code>mamba <span class="token function">install</span> conda-forge::r-matchit
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><h2 id="overview" tabindex="-1"><a class="header-anchor" href="#overview" aria-hidden="true">#</a> Overview</h2><p><code>MatchIt</code>为观察性研究中协变量平衡的各种匹配方法提供了一个简单明了的接口。匹配是估计治疗效果时减少混淆和模型依赖的一种方法。有几种匹配方法可供选择，包括最近邻匹配、最优对匹配、最优完全匹配、广义完全匹配、遗传匹配、精确匹配、粗化精确匹配、基数匹配和子分类，其中一些方法依赖于其他R包中的函数。包括用于估计倾向得分匹配的倾向得分的各种方法。下面是一个使用MatchIt进行马氏距离匹配和替换并评估平衡的示例：</p><div class="language-r line-numbers-mode" data-ext="r"><pre class="language-r"><code>library<span class="token punctuation">(</span><span class="token string">&quot;MatchIt&quot;</span><span class="token punctuation">)</span>
data<span class="token punctuation">(</span><span class="token string">&quot;lalonde&quot;</span><span class="token punctuation">,</span> package <span class="token operator">=</span> <span class="token string">&quot;MatchIt&quot;</span><span class="token punctuation">)</span>

<span class="token comment"># 1:1 nearest neighbor matching with replacement on </span>
<span class="token comment"># the Mahalanobis distance</span>
m.out <span class="token operator">&lt;-</span> matchit<span class="token punctuation">(</span>treat <span class="token operator">~</span> age <span class="token operator">+</span> educ <span class="token operator">+</span> race <span class="token operator">+</span> married <span class="token operator">+</span> nodegree <span class="token operator">+</span> re74 <span class="token operator">+</span> re75<span class="token punctuation">,</span>
    data <span class="token operator">=</span> lalonde<span class="token punctuation">,</span> distance <span class="token operator">=</span> <span class="token string">&quot;mahalanobis&quot;</span><span class="token punctuation">,</span> replace <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>打印 MatchIt 对象可以提供执行的匹配类型的详细信息。</p><div class="language-r line-numbers-mode" data-ext="r"><pre class="language-r"><code>m.out
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><div class="language-r line-numbers-mode" data-ext="r"><pre class="language-r"><code><span class="token comment">#&gt; A matchit object</span>
<span class="token comment">#&gt;  - method: 1:1 nearest neighbor matching with replacement</span>
<span class="token comment">#&gt;  - distance: Mahalanobis</span>
<span class="token comment">#&gt;  - number of obs.: 614 (original), 261 (matched)</span>
<span class="token comment">#&gt;  - target estimand: ATT</span>
<span class="token comment">#&gt;  - covariates: age, educ, race, married, nodegree, re74, re75</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>使用 <code>summary()</code>，我们可以查看原始样本和匹配样本的协变量平衡：</p><div class="language-r line-numbers-mode" data-ext="r"><pre class="language-r"><code><span class="token comment">#Checking balance before and after matching:</span>
summary<span class="token punctuation">(</span>m.out<span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-r line-numbers-mode" data-ext="r"><pre class="language-r"><code><span class="token comment">#&gt; </span>
<span class="token comment">#&gt; Call:</span>
<span class="token comment">#&gt; matchit(formula = treat ~ age + educ + race + married + nodegree + </span>
<span class="token comment">#&gt;     re74 + re75, data = lalonde, distance = &quot;mahalanobis&quot;, replace = TRUE)</span>
<span class="token comment">#&gt; </span>
<span class="token comment">#&gt; Summary of Balance for All Data:</span>
<span class="token comment">#&gt;            Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean eCDF Max</span>
<span class="token comment">#&gt; age              25.8162       28.0303         -0.3094     0.4400    0.0813   0.1577</span>
<span class="token comment">#&gt; educ             10.3459       10.2354          0.0550     0.4959    0.0347   0.1114</span>
<span class="token comment">#&gt; raceblack         0.8432        0.2028          1.7615          .    0.6404   0.6404</span>
<span class="token comment">#&gt; racehispan        0.0595        0.1422         -0.3498          .    0.0827   0.0827</span>
<span class="token comment">#&gt; racewhite         0.0973        0.6550         -1.8819          .    0.5577   0.5577</span>
<span class="token comment">#&gt; married           0.1892        0.5128         -0.8263          .    0.3236   0.3236</span>
<span class="token comment">#&gt; nodegree          0.7081        0.5967          0.2450          .    0.1114   0.1114</span>
<span class="token comment">#&gt; re74           2095.5737     5619.2365         -0.7211     0.5181    0.2248   0.4470</span>
<span class="token comment">#&gt; re75           1532.0553     2466.4844         -0.2903     0.9563    0.1342   0.2876</span>
<span class="token comment">#&gt; </span>
<span class="token comment">#&gt; Summary of Balance for Matched Data:</span>
<span class="token comment">#&gt;            Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean eCDF Max Std. Pair Dist.</span>
<span class="token comment">#&gt; age              25.8162       25.5405          0.0385     0.6524    0.0466   0.1892          0.4827</span>
<span class="token comment">#&gt; educ             10.3459       10.4270         -0.0403     1.1636    0.0077   0.0378          0.1963</span>
<span class="token comment">#&gt; raceblack         0.8432        0.8432          0.0000          .    0.0000   0.0000          0.0000</span>
<span class="token comment">#&gt; racehispan        0.0595        0.0595          0.0000          .    0.0000   0.0000          0.0000</span>
<span class="token comment">#&gt; racewhite         0.0973        0.0973          0.0000          .    0.0000   0.0000          0.0000</span>
<span class="token comment">#&gt; married           0.1892        0.1784          0.0276          .    0.0108   0.0108          0.0276</span>
<span class="token comment">#&gt; nodegree          0.7081        0.7081          0.0000          .    0.0000   0.0000          0.0000</span>
<span class="token comment">#&gt; re74           2095.5737     1788.6941          0.0628     1.5690    0.0311   0.1730          0.2494</span>
<span class="token comment">#&gt; re75           1532.0553     1087.7420          0.1380     2.1221    0.0330   0.0865          0.2360</span>
<span class="token comment">#&gt; </span>
<span class="token comment">#&gt; Sample Sizes:</span>
<span class="token comment">#&gt;               Control Treated</span>
<span class="token comment">#&gt; All               429     185</span>
<span class="token comment">#&gt; Matched (ESS)      33     185</span>
<span class="token comment">#&gt; Matched            76     185</span>
<span class="token comment">#&gt; Unmatched         353       0</span>
<span class="token comment">#&gt; Discarded           0       0</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>最上面是原始样品的平衡。下面是匹配样本的平衡，然后是不平衡的减少百分比以及匹配前后的样本量。平衡统计值越小，表示平衡越好。（在这种情况下，没有实现良好的平衡，应尝试其他匹配方法）。我们可以在Love图中绘制标准化的平均差异，以清晰、直观地显示整个样本的平衡：</p><div class="language-r line-numbers-mode" data-ext="r"><pre class="language-r"><code><span class="token comment">#Plot balance</span>
plot<span class="token punctuation">(</span>summary<span class="token punctuation">(</span>m.out<span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div></div></div>`,14)),a("figure",null,[a("a",m,[n[0]||(n[0]=a("img",{src:"https://i.postimg.cc/QdvdtWQJ/matchit-love-plot.png",alt:"matchit-love-plot.png",tabindex:"0",loading:"lazy"},null,-1)),e(s)]),n[1]||(n[1]=a("figcaption",null,"matchit-love-plot.png",-1))]),p(" [![matchit-love-plot](https://kosukeimai.github.io/MatchIt/reference/figures/README-unnamed-chunk-5-1.png)](https://kosukeimai.github.io/MatchIt/reference/figures/README-unnamed-chunk-5-1.png) "),n[5]||(n[5]=t(`<h2 id="参数调教" tabindex="-1"><a class="header-anchor" href="#参数调教" aria-hidden="true">#</a> 参数调教</h2><p>我们将讨论如何使用 R <code>MatchIt</code>包进行倾向得分匹配 (Propensity Scores Matching)</p><ul><li>倾向得分是得到<code>treatment</code>的概率，所以,我们需要使用混杂因素来预测得到treatment的概率。</li><li><code>method=&#39;nearest&#39;</code> 表示我们使用的是最近邻法。最近邻匹配是一种广泛使用的贪心匹配方法。贪婪匹配此时匹配最近的对照组样本，并将匹配的对照组样本从匹配的其余部分中删除。它速度很快，但对样本的顺序很敏感。将总距离最小化并不是最优的，因为在过程后期将出现匹配的样本无法与已匹配的对照匹配的现象。</li><li><code>distance = &#39;glm&#39;</code>意味着我们采用倾向得分差异进行最近邻匹配。默认设置是从实验组中的最高倾向得分到最低倾向得分进行匹配。这确保了难以匹配的数据点首先被匹配。</li><li><code>ratio=1</code> 表示一个treatment单元与一个对照单元匹配。当比值大于 1 时，一个以上的对照单元将与每个实验单元匹配。如果我们希望为每个实验单元匹配 2 个对照组样本，则将对<code>treatment</code>组中的所有单元执行最近邻匹配以获得第一个匹配，然后重复该过程以获得第二个匹配。当倾向得分相同时，将选择数据集中具有较高顺序的得分。这确保了结果的可重复性。</li><li><code>replace=F</code>意味着对照组中的每个样本仅与实验组中的一个样本匹配。</li><li><code>caliper</code>是任何匹配的距离阈值。距离大于卡尺距离的匹配对将被丢弃。<code>caliper=0.2</code>意味着将丢弃超过 20% 的倾向得分标准差的匹配项。</li></ul><div class="language-r line-numbers-mode" data-ext="r"><pre class="language-r"><code><span class="token comment"># PSM matchit  </span>
m.out <span class="token operator">&lt;-</span> matchit<span class="token punctuation">(</span>treat <span class="token operator">~</span> age <span class="token operator">+</span> educ <span class="token operator">+</span> race <span class="token operator">+</span> married <span class="token operator">+</span> nodegree <span class="token operator">+</span> re74 <span class="token operator">+</span> re75<span class="token punctuation">,</span>
    data <span class="token operator">=</span> lalonde<span class="token punctuation">,</span> distance <span class="token operator">=</span> <span class="token string">&quot;mahalanobis&quot;</span><span class="token punctuation">,</span> replace <span class="token operator">=</span> <span class="token boolean">TRUE</span><span class="token punctuation">)</span>
m.out <span class="token operator">&lt;-</span> matchit<span class="token punctuation">(</span>treat <span class="token operator">~</span> age <span class="token operator">+</span> educ <span class="token operator">+</span> race <span class="token operator">+</span> married <span class="token operator">+</span> nodegree <span class="token operator">+</span> re74 <span class="token operator">+</span> re75<span class="token punctuation">,</span>
    data <span class="token operator">=</span> lalonde<span class="token punctuation">,</span> distance <span class="token operator">=</span> <span class="token string">&#39;glm&#39;</span><span class="token punctuation">,</span> method <span class="token operator">=</span> <span class="token string">&#39;nearest&#39;</span><span class="token punctuation">,</span>
    atio <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">,</span> replace <span class="token operator">=</span> <span class="token boolean">FALSE</span><span class="token punctuation">,</span> caliper <span class="token operator">=</span> <span class="token number">0.2</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="参考链接" tabindex="-1"><a class="header-anchor" href="#参考链接" aria-hidden="true">#</a> 参考链接：</h2>`,5)),a("ol",null,[a("li",null,[a("a",u,[n[2]||(n[2]=o("官方文档")),e(s)])]),a("li",null,[a("a",v,[n[3]||(n[3]=o("倾向性匹配得分")),e(s)])])])])}const h=c(d,[["render",k],["__file","matchIt.html.vue"]]);export{h as default};
